# Deposit Final Payment Flow

## ‚úÖ ƒê√£ Ho√†n Th√†nh

ƒê√£ tri·ªÉn khai ch·ª©c nƒÉng thanh to√°n ph·∫ßn c√≤n l·∫°i cho deposits v·ªõi QR code v√† auto-save v√†o c√°c m√†n h√¨nh t∆∞∆°ng ·ª©ng.

---

## üéØ Complete Flow

### **Flow 1: Tr·∫£ Full**
```
Deposit (ƒê√£ x√°c nh·∫≠n) ‚Üí Thanh to√°n ph·∫ßn c√≤n l·∫°i
  ‚Üì
Ch·ªçn "Tr·∫£ full"
  ‚Üì
QR Payment Modal
  ‚Ä¢ Hi·ªÉn th·ªã s·ªë ti·ªÅn: 1.000.000.000 ‚Ç´
  ‚Ä¢ QR Code (VNPay Demo)
  ‚Ä¢ Instructions
  ‚Üì
Kh√°ch h√†ng qu√©t QR ‚Üí Thanh to√°n
  ‚Üì
Staff nh·∫•n "X√°c nh·∫≠n thanh to√°n"
  ‚Üì
Processing (2 seconds)
  ‚Üì
‚úÖ Actions:
  1. Create Quotation ‚Üí Save to Sales (QuotationManagement)
     ‚Ä¢ Status: 'paid'
     ‚Ä¢ PaymentType: 'full'
     ‚Ä¢ Filter: "ƒê√£ thanh to√°n"
  
  2. Add Customer ‚Üí Save to Customers (CustomerManagement)
     ‚Ä¢ Tab: "Kh√°ch h√†ng"
     ‚Ä¢ purchaseDate: today
     ‚Ä¢ orderValue: vehicle price
  
  3. Update Deposit ‚Üí Status: 'completed'
     ‚Ä¢ finalPaymentType: 'full'
     ‚Ä¢ quotationId: linked
  ‚Üì
Success Alert:
  "‚úÖ ƒê√£ thanh to√°n full!
   üìã B√°o gi√° [ID] ƒë√£ ƒë∆∞·ª£c t·∫°o
   üë§ Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c th√™m v√†o danh s√°ch
   
   ‚û°Ô∏è Xem t·∫°i m√†n h√¨nh 'Sales' v√† 'Customers'"
  ‚Üì
Navigate back
  ‚Üì
‚úÖ Deposit appears in "Ho√†n th√†nh" filter
```

### **Flow 2: Tr·∫£ G√≥p**
```
Deposit (ƒê√£ x√°c nh·∫≠n) ‚Üí Thanh to√°n ph·∫ßn c√≤n l·∫°i
  ‚Üì
Ch·ªçn "Tr·∫£ g√≥p" ‚Üí Ch·ªçn k·ª≥ h·∫°n (12 th√°ng)
  ‚Üì
Nh·∫•n "X√°c nh·∫≠n tr·∫£ g√≥p 12 th√°ng"
  ‚Üì
QR Payment Modal
  ‚Ä¢ Hi·ªÉn th·ªã s·ªë ti·ªÅn: 1.000.000.000 ‚Ç´
  ‚Ä¢ Note: "Tr·∫£ g√≥p 12 th√°ng ‚Ä¢ 88.000.000 ‚Ç´/th√°ng"
  ‚Ä¢ QR Code (VNPay Demo)
  ‚Üì
Kh√°ch h√†ng qu√©t QR ‚Üí Thanh to√°n k·ª≥ ƒë·∫ßu
  ‚Üì
Staff nh·∫•n "X√°c nh·∫≠n thanh to√°n"
  ‚Üì
Processing (2 seconds)
  ‚Üì
‚úÖ Actions:
  1. Create Installment Plan ‚Üí Save to Installments
     ‚Ä¢ quotationId: Q-[DepositID]
     ‚Ä¢ totalAmount: 1.000.000.000 ‚Ç´
     ‚Ä¢ months: 12
     ‚Ä¢ monthlyPayment: calculated
     ‚Ä¢ paymentSchedule: generated
  
  2. Update Deposit ‚Üí Status: 'completed'
     ‚Ä¢ finalPaymentType: 'installment'
     ‚Ä¢ installmentMonths: 12
     ‚Ä¢ installmentId: linked
  ‚Üì
Success Alert:
  "‚úÖ K·∫ø ho·∫°ch tr·∫£ g√≥p 12 th√°ng ƒë√£ ƒë∆∞·ª£c t·∫°o!
   üìÖ M√£ tr·∫£ g√≥p: [ID]
   üí∞ Tr·∫£ h√†ng th√°ng: 88.000.000 ‚Ç´
   
   ‚û°Ô∏è Xem t·∫°i m√†n h√¨nh 'Qu·∫£n l√Ω tr·∫£ g√≥p'"
  ‚Üì
Navigate back
  ‚Üì
‚úÖ Deposit appears in "Ho√†n th√†nh" filter
‚úÖ Installment appears in InstallmentManagement
```

---

## üîß Technical Implementation

### **1. Payment Type Selection:**

```javascript
const handlePaymentTypeSelect = (paymentType) => {
  if (paymentType === 'full') {
    // Direct to QR payment for full payment
    setSelectedPaymentType('full');
    setShowPaymentTypeModal(false);
    setTimeout(() => setShowQRPaymentModal(true), 300);
  }
  // For installment, just select it (user will click confirm button)
};

const handleConfirmInstallmentPayment = () => {
  setShowPaymentTypeModal(false);
  setTimeout(() => setShowQRPaymentModal(true), 300);
};
```

### **2. Process Full Payment:**

```javascript
const processFullPayment = async () => {
  try {
    // 1. Create quotation from deposit
    const quotationData = {
      customerId: deposit.customerId,
      customerName: deposit.customerName,
      customerPhone: deposit.customerPhone,
      vehicleModel: deposit.vehicleModel,
      vehicleColor: deposit.vehicleColor,
      items: [{
        vehicleId: deposit.vehicleId,
        model: deposit.vehicleModel,
        color: deposit.vehicleColor,
        price: deposit.vehiclePrice,
        quantity: 1,
      }],
      pricing: {
        basePrice: deposit.vehiclePrice,
        totalPrice: deposit.vehiclePrice,
      },
      totalAmount: deposit.vehiclePrice,
      status: 'paid',           // ‚úÖ Status: paid
      paymentType: 'full',      // ‚úÖ Payment type: full
      paymentStatus: 'completed',
      paymentCompletedAt: new Date().toISOString(),
      notes: `T·ª´ ƒë·∫∑t c·ªçc ${deposit.id}`,
      depositId: deposit.id,    // ‚úÖ Link to deposit
    };

    const newQuotation = await quotationStorageService.addQuotation(quotationData);
    console.log('‚úÖ Quotation created:', newQuotation.id);

    // 2. Add customer to management
    await CustomerManagementService.addCustomerFromQuotation({
      ...newQuotation,
      customerName: deposit.customerName,
      customerPhone: deposit.customerPhone,
      vehicleModel: deposit.vehicleModel,
      vehicleColor: deposit.vehicleColor,
      totalAmount: deposit.vehiclePrice,
    });
    console.log('‚úÖ Customer added to management');

    // 3. Update deposit status
    await depositStorageService.updateDeposit(deposit.id, {
      status: 'completed',
      finalPaymentType: 'full',
      finalPaymentDate: new Date().toISOString(),
      quotationId: newQuotation.id,
    });

    // Success alert
    Alert.alert(
      'Thanh to√°n th√†nh c√¥ng',
      `‚úÖ ƒê√£ thanh to√°n full!\n\nüìã B√°o gi√° ${newQuotation.id} ƒë√£ ƒë∆∞·ª£c t·∫°o\nüë§ Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c th√™m v√†o danh s√°ch\n\n‚û°Ô∏è Xem t·∫°i m√†n h√¨nh "Sales" v√† "Customers"`
    );
  } catch (error) {
    console.error('Error processing full payment:', error);
    throw error;
  }
};
```

### **3. Process Installment Payment:**

```javascript
const processInstallmentPayment = async () => {
  try {
    // 1. Create installment plan
    const installment = await installmentStorageService.createInstallment({
      quotationId: `Q-${deposit.id}`,  // ‚úÖ Link to deposit
      customerId: deposit.customerId,
      customerName: deposit.customerName,
      customerPhone: deposit.customerPhone,
      vehicleModel: deposit.vehicleModel,
      vehicleColor: deposit.vehicleColor,
      totalAmount: deposit.remainingAmount,
      installmentMonths: installmentMonths,
      interestRate: 6.0,
      startDate: new Date().toISOString(),
      depositId: deposit.id,            // ‚úÖ Link to deposit
    });
    console.log('‚úÖ Installment created:', installment.id);

    // 2. Update deposit status
    await depositStorageService.updateDeposit(deposit.id, {
      status: 'completed',
      finalPaymentType: 'installment',
      installmentMonths: installmentMonths,
      installmentId: installment.id,    // ‚úÖ Link to installment
      finalPaymentDate: new Date().toISOString(),
    });

    // Success alert
    Alert.alert(
      'Thanh to√°n th√†nh c√¥ng',
      `‚úÖ K·∫ø ho·∫°ch tr·∫£ g√≥p ${installmentMonths} th√°ng ƒë√£ ƒë∆∞·ª£c t·∫°o!\n\nüìÖ M√£ tr·∫£ g√≥p: ${installment.id}\nüí∞ Tr·∫£ h√†ng th√°ng: ${formatCurrency(installment.monthlyPayment)}\n\n‚û°Ô∏è Xem t·∫°i m√†n h√¨nh "Qu·∫£n l√Ω tr·∫£ g√≥p"`
    );
  } catch (error) {
    console.error('Error processing installment payment:', error);
    throw error;
  }
};
```

### **4. QR Payment Modal:**

```javascript
<Modal visible={showQRPaymentModal} animationType="slide" transparent={true}>
  <View style={styles.modalOverlay}>
    <View style={styles.qrPaymentModalContent}>
      <View style={styles.modalHeader}>
        <Text style={styles.modalTitle}>Thanh to√°n ph·∫ßn c√≤n l·∫°i</Text>
        {!processingPayment && (
          <TouchableOpacity onPress={() => setShowQRPaymentModal(false)}>
            <Text style={styles.closeIcon}>√ó</Text>
          </TouchableOpacity>
        )}
      </View>

      <ScrollView>
        {/* Payment Info */}
        <View style={styles.qrPaymentInfo}>
          <Text style={styles.qrPaymentLabel}>S·ªë ti·ªÅn thanh to√°n:</Text>
          <Text style={styles.qrPaymentAmount}>
            {formatCurrency(deposit.remainingAmount)}
          </Text>
          {selectedPaymentType === 'installment' && (
            <Text style={styles.qrPaymentNote}>
              Tr·∫£ g√≥p {installmentMonths} th√°ng ‚Ä¢ {formatCurrency(monthlyPayment)}/th√°ng
            </Text>
          )}
          {selectedPaymentType === 'full' && (
            <Text style={styles.qrPaymentNote}>Thanh to√°n full</Text>
          )}
        </View>

        {/* QR Code */}
        <View style={styles.qrSection}>
          <Text style={styles.qrTitle}>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</Text>
          <View style={styles.qrContainer}>
            <View style={styles.qrPlaceholder}>
              <Text style={styles.qrIcon}>üì±</Text>
              <Text style={styles.qrText}>VNPay QR Code</Text>
              <Text style={styles.qrData}>Demo Mode</Text>
            </View>
          </View>
        </View>

        {/* Instructions */}
        <View style={styles.paymentInstructions}>
          <Text style={styles.instructionsTitle}>H∆∞·ªõng d·∫´n thanh to√°n:</Text>
          <Text style={styles.instructionText}>1. M·ªü ·ª©ng d·ª•ng VNPay ho·∫∑c app ng√¢n h√†ng</Text>
          <Text style={styles.instructionText}>2. Qu√©t m√£ QR ph√≠a tr√™n</Text>
          <Text style={styles.instructionText}>3. X√°c nh·∫≠n th√¥ng tin thanh to√°n</Text>
          <Text style={styles.instructionText}>4. Nh·∫•n "X√°c nh·∫≠n thanh to√°n" b√™n d∆∞·ªõi</Text>
        </View>

        {/* Confirm Button */}
        <TouchableOpacity
          style={[styles.confirmPaymentButton, processingPayment && styles.disabledButton]}
          onPress={processDepositPayment}
          disabled={processingPayment}
        >
          <LinearGradient
            colors={processingPayment ? ['#CCCCCC', '#999999'] : COLORS.GRADIENT.GREEN}
            style={styles.confirmPaymentButtonGradient}
          >
            {processingPayment ? (
              <>
                <ActivityIndicator color={COLORS.TEXT.WHITE} style={{ marginRight: 10 }} />
                <Text style={styles.confirmPaymentButtonText}>ƒêang x·ª≠ l√Ω...</Text>
              </>
            ) : (
              <Text style={styles.confirmPaymentButtonText}>‚úì X√°c nh·∫≠n thanh to√°n</Text>
            )}
          </LinearGradient>
        </TouchableOpacity>
      </ScrollView>
    </View>
  </View>
</Modal>
```

---

## üìä Data Relationships

### **Full Payment:**
```
Deposit (DEP001)
  ‚Üì
Payment (Full)
  ‚Üì
Creates:
  ‚îú‚îÄ Quotation (Q123456)
  ‚îÇ   ‚îú‚îÄ status: 'paid'
  ‚îÇ   ‚îú‚îÄ paymentType: 'full'
  ‚îÇ   ‚îú‚îÄ depositId: 'DEP001'
  ‚îÇ   ‚îî‚îÄ totalAmount: 1.250.000.000 ‚Ç´
  ‚îÇ
  ‚îî‚îÄ Customer (C789012)
      ‚îú‚îÄ purchaseDate: today
      ‚îú‚îÄ orderValue: 1.250.000.000 ‚Ç´
      ‚îú‚îÄ vehicleModel: 'Tesla Model Y'
      ‚îî‚îÄ vehicleColor: 'ƒêen'

Deposit updated:
  ‚îú‚îÄ status: 'completed'
  ‚îú‚îÄ finalPaymentType: 'full'
  ‚îî‚îÄ quotationId: 'Q123456'
```

### **Installment Payment:**
```
Deposit (DEP001)
  ‚Üì
Payment (Installment - 12 months)
  ‚Üì
Creates:
  ‚îî‚îÄ Installment (INST345678)
      ‚îú‚îÄ quotationId: 'Q-DEP001'
      ‚îú‚îÄ depositId: 'DEP001'
      ‚îú‚îÄ totalAmount: 1.000.000.000 ‚Ç´
      ‚îú‚îÄ installmentMonths: 12
      ‚îú‚îÄ monthlyPayment: 88.000.000 ‚Ç´
      ‚îî‚îÄ paymentSchedule: [12 payments]

Deposit updated:
  ‚îú‚îÄ status: 'completed'
  ‚îú‚îÄ finalPaymentType: 'installment'
  ‚îú‚îÄ installmentMonths: 12
  ‚îî‚îÄ installmentId: 'INST345678'
```

---

## üì± UI Preview

### **Payment Type Modal (Unselected State):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ch·ªçn h√¨nh th·ª©c thanh to√°n         √ó ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ (White bg, black text)
‚îÇ ‚îÇ üí∞ Tr·∫£ full                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ    Thanh to√°n m·ªôt l·∫ßn            ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ T·ªïng: 1.000.000.000 ‚Ç´           ‚îÇ ‚îÇ (Gray box)
‚îÇ ‚îÇ L√£i su·∫•t: 0%                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚úì Kh√¥ng ph√°t sinh l√£i            ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ (White bg, black text)
‚îÇ ‚îÇ üìÖ Tr·∫£ g√≥p                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ    Thanh to√°n theo th√°ng         ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ Tr·∫£/th√°ng: 88.000.000 ‚Ç´         ‚îÇ ‚îÇ (Gray box)
‚îÇ ‚îÇ T·ªïng: 1.056.000.000 ‚Ç´           ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚úì Thanh to√°n linh ho·∫°t           ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Payment Type Modal (Full Selected):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ch·ªçn h√¨nh th·ª©c thanh to√°n         √ó ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ (Blue gradient, white text)
‚îÇ ‚îÇ üí∞ Tr·∫£ full                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ    Thanh to√°n m·ªôt l·∫ßn            ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ T·ªïng: 1.000.000.000 ‚Ç´           ‚îÇ ‚îÇ (Semi-transparent white)
‚îÇ ‚îÇ L√£i su·∫•t: 0%                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚úì Kh√¥ng ph√°t sinh l√£i            ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ [Automatically opens QR modal]       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Payment Type Modal (Installment Selected):**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Ch·ªçn h√¨nh th·ª©c thanh to√°n         √ó ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ (Purple gradient, white text)
‚îÇ ‚îÇ üìÖ Tr·∫£ g√≥p                       ‚îÇ ‚îÇ
‚îÇ ‚îÇ    Thanh to√°n theo th√°ng         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ Ch·ªçn k·ª≥ h·∫°n:                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ [6] [12‚úì] [24] [36] th√°ng       ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ Tr·∫£/th√°ng: 88.000.000 ‚Ç´         ‚îÇ ‚îÇ (Semi-transparent white)
‚îÇ ‚îÇ T·ªïng: 1.056.000.000 ‚Ç´           ‚îÇ ‚îÇ
‚îÇ ‚îÇ L√£i: 6%/nƒÉm                     ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚úì Thanh to√°n linh ho·∫°t           ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ [X√°c nh·∫≠n tr·∫£ g√≥p 12 th√°ng]     ‚îÇ ‚îÇ (Blue button)
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **QR Payment Modal:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Thanh to√°n ph·∫ßn c√≤n l·∫°i           √ó ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ (Blue info card)
‚îÇ ‚îÇ  S·ªë ti·ªÅn thanh to√°n:            ‚îÇ ‚îÇ
‚îÇ ‚îÇ  1.000.000.000 ‚Ç´                ‚îÇ ‚îÇ (Big, bold)
‚îÇ ‚îÇ  Tr·∫£ full / Tr·∫£ g√≥p 12 th√°ng    ‚îÇ ‚îÇ (Note)
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ Qu√©t m√£ QR ƒë·ªÉ thanh to√°n            ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ ‚îÇ
‚îÇ ‚îÇ‚îÇ                               ‚îÇ‚îÇ ‚îÇ
‚îÇ ‚îÇ‚îÇ       üì±                      ‚îÇ‚îÇ ‚îÇ
‚îÇ ‚îÇ‚îÇ   VNPay QR Code               ‚îÇ‚îÇ ‚îÇ
‚îÇ ‚îÇ‚îÇ   Demo Mode                   ‚îÇ‚îÇ ‚îÇ
‚îÇ ‚îÇ‚îÇ                               ‚îÇ‚îÇ ‚îÇ
‚îÇ ‚îÇ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ (Yellow box)
‚îÇ ‚îÇ H∆∞·ªõng d·∫´n thanh to√°n:           ‚îÇ ‚îÇ
‚îÇ ‚îÇ 1. M·ªü ·ª©ng d·ª•ng VNPay            ‚îÇ ‚îÇ
‚îÇ ‚îÇ 2. Qu√©t m√£ QR ph√≠a tr√™n         ‚îÇ ‚îÇ
‚îÇ ‚îÇ 3. X√°c nh·∫≠n th√¥ng tin           ‚îÇ ‚îÇ
‚îÇ ‚îÇ 4. Nh·∫•n "X√°c nh·∫≠n" b√™n d∆∞·ªõi     ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                      ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  ‚úì X√°c nh·∫≠n thanh to√°n          ‚îÇ ‚îÇ (Green gradient)
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Processing State:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ  ‚è≥ ƒêang x·ª≠ l√Ω...                ‚îÇ ‚îÇ (Gray, disabled)
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üöÄ Backend Integration Ready

### **API Endpoints:**

```javascript
// Full payment
POST /api/deposits/:depositId/final-payment/full
{
  depositId: 'DEP001',
  customerId: 'C123',
  remainingAmount: 1000000000,
  paymentMethod: 'vnpay_qr',
}

Response:
{
  success: true,
  quotation: {
    id: 'Q123456',
    status: 'paid',
    paymentType: 'full',
  },
  customer: {
    id: 'C123',
    addedToManagement: true,
  },
  deposit: {
    id: 'DEP001',
    status: 'completed',
    finalPaymentType: 'full',
  },
}

// Installment payment
POST /api/deposits/:depositId/final-payment/installment
{
  depositId: 'DEP001',
  customerId: 'C123',
  remainingAmount: 1000000000,
  installmentMonths: 12,
  interestRate: 6.0,
  paymentMethod: 'vnpay_qr',
}

Response:
{
  success: true,
  installment: {
    id: 'INST345678',
    quotationId: 'Q-DEP001',
    monthlyPayment: 88000000,
    paymentSchedule: [...],
  },
  deposit: {
    id: 'DEP001',
    status: 'completed',
    finalPaymentType: 'installment',
    installmentId: 'INST345678',
  },
}

// VNPay QR Code
POST /api/payments/vnpay/create-qr
{
  amount: 1000000000,
  orderId: 'DEP001',
  orderInfo: 'Thanh to√°n ph·∫ßn c√≤n l·∫°i ƒë·∫∑t c·ªçc',
}

Response:
{
  qrCode: 'data:image/png;base64,...',
  paymentUrl: 'https://sandbox.vnpayment.vn/...',
  transactionId: 'VNP123456789',
}
```

---

## ‚úÖ Features Summary

### **Completed:**
```
‚úÖ Payment type selection modal (white bg default)
‚úÖ Conditional gradient (selected state only)
‚úÖ QR payment modal for both full & installment
‚úÖ Full payment flow:
   ‚úÖ Create quotation ‚Üí Sales (status: paid)
   ‚úÖ Add customer ‚Üí Customers tab
   ‚úÖ Update deposit ‚Üí completed
‚úÖ Installment payment flow:
   ‚úÖ Create installment plan ‚Üí Installments
   ‚úÖ Update deposit ‚Üí completed
‚úÖ Processing state with loading indicator
‚úÖ Success alerts with navigation hints
‚úÖ Auto-link related records (quotationId, installmentId)
‚úÖ Error handling
‚úÖ Console logging for debugging
‚úÖ No linter errors
```

---

## üß™ Testing

### **Test Full Payment:**
```
1. Deposit v·ªõi status 'confirmed' (ƒê√£ x√°c nh·∫≠n)
2. Click "Thanh to√°n ph·∫ßn c√≤n l·∫°i"
3. ‚úÖ Payment type modal opens (both cards white)
4. Click "Tr·∫£ full"
5. ‚úÖ Card turns blue with white text
6. ‚úÖ QR modal auto-opens
7. ‚úÖ See amount: 1.000.000.000 ‚Ç´
8. ‚úÖ See note: "Thanh to√°n full"
9. Click "X√°c nh·∫≠n thanh to√°n"
10. ‚úÖ Button shows loading: "ƒêang x·ª≠ l√Ω..."
11. ‚úÖ After 2s, success alert
12. ‚úÖ Navigate back
13. Verify:
   ‚úÖ Sales screen ‚Üí New quotation (paid)
   ‚úÖ Customers screen ‚Üí New customer
   ‚úÖ Deposit ‚Üí Status: completed
```

### **Test Installment Payment:**
```
1. Deposit v·ªõi status 'confirmed'
2. Click "Thanh to√°n ph·∫ßn c√≤n l·∫°i"
3. ‚úÖ Payment type modal opens (both cards white)
4. Click "Tr·∫£ g√≥p"
5. ‚úÖ Card turns purple with white text
6. ‚úÖ Month options appear
7. Select "12 th√°ng"
8. ‚úÖ See calculations update
9. Click "X√°c nh·∫≠n tr·∫£ g√≥p 12 th√°ng"
10. ‚úÖ QR modal auto-opens
11. ‚úÖ See amount with installment note
12. Click "X√°c nh·∫≠n thanh to√°n"
13. ‚úÖ Button shows loading
14. ‚úÖ After 2s, success alert
15. ‚úÖ Navigate back
16. Verify:
   ‚úÖ Installments screen ‚Üí New plan
   ‚úÖ Deposit ‚Üí Status: completed
```

---

## ‚ú® Summary

**Deposit final payment flow ho√†n ch·ªânh!** üéØ

- ‚úÖ **Tr·∫£ full**: QR ‚Üí Quotation (Sales) + Customer (Customers)
- ‚úÖ **Tr·∫£ g√≥p**: QR ‚Üí Installment plan (Installments)
- ‚úÖ **Both**: Update deposit to completed
- ‚úÖ Auto-link records with IDs
- ‚úÖ Beautiful QR modal UI
- ‚úÖ Processing state with loading
- ‚úÖ Clear success messages
- ‚úÖ Ready for VNPay integration

**Ready for backend! üöÄ**
